{"metadata":{"guid":"d89a2f2f-f90f-4e9e-885c-1adc0f7130e6","url":"/v2/streaming_pipelines/d89a2f2f-f90f-4e9e-885c-1adc0f7130e6","created_at":"2017-12-04T23:26:46Z","updated_at":"2017-12-11T20:24:06Z","revision":1513023846564},"entity":{"name":"revenue by state or country","description":"","project_guid":"6d71c059-452b-4e29-989a-49d646de58a7","graph":{"doc_type":"pipeline","version":"1.0","json_schema":"http://www.ibm.com/ibm/wdp/flow-v1.0/pipeline-flow-v1-schema.json","id":"","app_data":{"ui_data":{"name":"revenue by state or country"}},"primary_pipeline":"primary-pipeline","pipelines":[{"id":"primary-pipeline","runtime":"streams","nodes":[{"id":"messagehub_2xl7907zqxy","type":"binding","op":"ibm.streams.sources.messagehub","outputs":[{"id":"target","schema_ref":"schema0","links":[{"node_id_ref":"code_elz29jjkwbv","port_id_ref":"source"}]}],"parameters":{"schema_mapping":[{"name":"customer_id","type":"string","path":"/customer_id"},{"name":"click_event_type","type":"string","length":255,"path":"/click_event_type"},{"name":"total_price_of_basket","type":"double","path":"/total_price_of_basket"},{"name":"total_number_of_items_in_basket","type":"double","path":"/total_number_of_items_in_basket"},{"name":"total_number_of_distinct_items_in_basket","type":"double","path":"/total_number_of_distinct_items_in_basket"},{"name":"session_duration","type":"double","path":"/session_duration"},{"name":"event_time","type":"string","length":255,"path":"/event_time"}]},"connection":{"ref":"bc9166ec-e690-4b7f-a57a-a457da9dc5ec","project_ref":"6d71c059-452b-4e29-989a-49d646de58a7","properties":{"asset":{"id":"logout_with_purchase","name":"logout_with_purchase","type":"topic","path":"/logout_with_purchase"}}},"app_data":{"ui_data":{"label":"Message Hub","x_pos":-400,"y_pos":170}}},{"id":"code_elz29jjkwbv","type":"execution_node","op":"ibm.streams.operations.code","outputs":[{"id":"target","schema_ref":"schema1","links":[{"node_id_ref":"freeform_filter_q4zc2wk0n3","port_id_ref":"source"},{"node_id_ref":"freeform_filter_r5lqa9viwmc","port_id_ref":"source"}]}],"parameters":{"code":"#\n# YOU MUST EDIT THE SCHEMA and add all attributes that you are returning as output.\n#\n# Python libraries that are supported and selected (âœ“) at the \"In Installer\" list at\n# https://docs.continuum.io/anaconda/packages/pkg-docs\n\nimport csv\nimport sys\nimport requests\nfrom io import StringIO\n\n# init() function will be called once on pipeline initialization\n# @state a Python dictionary object for keeping state. The state object is passed to the process function\ndef init(state):\n    # do something once on pipeline initialization and save in the state object\n    # download customer location data\n    source = \"https://raw.githubusercontent.com/wdp-beta/get-started/beta_2/data/dc-beta-scenario-customers.csv\"\n    r = requests.get(source)\n    if r.status_code == 200:\n        reader = csv.DictReader(StringIO(r.text))\n        state['c_lookup'] = {}\n        for row in reader:\n            state['c_lookup'][row['CUST_ID']] = {}\n            state['c_lookup'][row['CUST_ID']]['state'] = row.get('STATE', None)\n            state['c_lookup'][row['CUST_ID']]['country_code'] = row.get('COUNTRY_CODE', None)\n            state['c_lookup'][row['CUST_ID']]['postal_code'] = row.get('POSTAL_CODE', None)\n    else:\n        print(\"Load from {} failed: {} {}\".format(source, r.status_code. r.statusMessage))  \n\n\n# process() function will be invoked on every event tuple\n# @event a Python dictionary object representing the input event tuple as defined by the input schema\n# @state a Python dictionary object for keeping state over subsequent function calls\n# return must be a Python dictionary object. It will be the output of this operator.\n#        Returning None results in not submitting an output tuple for this invocation.\n# You must declare all output attributes in the Edit Schema window.\ndef process(event, state):\n    debug = False\n    event['c_state'] = None\n    event['c_country_code'] = None\n    event['debug'] = None\n    \n    if state.get('c_lookup', None) is not None:\n        if state['c_lookup'].get(event['customer_id'], None) is not None:        \n            if debug:\n                event['debug'] = 'found customer {}'.format(event['customer_id'])\n            event['c_state'] = state['c_lookup'][event['customer_id']]['state']\n            event['c_country_code'] = state['c_lookup'][event['customer_id']]['country_code']\n            event['c_postal_code'] = state['c_lookup'][event['customer_id']]['postal_code']\n            return event\n        else:\n            if debug:\n                event['debug'] = \"customer_id {} was not found\".format(event['customer_id'])\n            else:\n                return None\n    else:\n        if debug:\n            event['debug'] = \"c_lookup disctionary was not found\"\n        else:\n            return None","schema_mapping":[{"name":"status","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"c_country_code","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"c_state","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"c_postal_code","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"customer_id","type":"string"},{"name":"click_event_type","type":"string","length":255},{"name":"total_price_of_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"session_duration","type":"double"},{"name":"event_time","type":"string","length":255}]},"app_data":{"ui_data":{"label":"Add customer location","x_pos":-170,"y_pos":170}}},{"id":"freeform_filter_q4zc2wk0n3","type":"execution_node","op":"ibm.streams.operations.freeform-filter","outputs":[{"id":"target","schema_ref":"schema2","links":[{"node_id_ref":"aggregate_p49r0s1qj9b","port_id_ref":"source"}]}],"parameters":{"expression":"c_country_code == 'US' "},"app_data":{"ui_data":{"label":"us revenue","x_pos":50,"y_pos":80}}},{"id":"aggregate_p49r0s1qj9b","type":"execution_node","op":"ibm.streams.operations.aggregate","outputs":[{"id":"target","schema_ref":"schema3","links":[{"node_id_ref":"objectstorage_v2_wra3zvt4mo7","port_id_ref":"source"}]}],"parameters":{"window_time_unit":"minute","window_number_of_time_units":"15","use_timestamp_in_tuple":false,"partition_by":"","group_by":"c_postal_code","aggregation_output":[{"name":"us_zip","value":{"function":"Any","type":"varchar","arguments":["c_postal_code"]},"type":""},{"name":"us_state","value":{"function":"Any","type":"varchar","arguments":["c_state"]},"type":""},{"name":"revenue","value":{"function":"Sum","type":"double","arguments":["total_price_of_basket"]},"type":""}],"schema_mapping":[{"name":"us_zip","type":"string"},{"name":"us_state","type":"string"},{"name":"revenue","type":"double"}]},"app_data":{"ui_data":{"label":"Revenue by state","x_pos":260,"y_pos":80}}},{"id":"objectstorage_v2_wra3zvt4mo7","type":"binding","op":"ibm.streams.targets.objectstorage_v2","parameters":{"header_row_enabled":true,"write_policy":"time","rolling_time_seconds":"60"},"connection":{"ref":"efa05126-da64-4104-8ba4-0e380dc2f292","project_ref":"6d71c059-452b-4e29-989a-49d646de58a7","properties":{"asset":{"path":"/revenue-analysis/us_revenue_%TIME.csv","asset_types":[],"assets":[],"fields":[],"extended_metadata":[],"first":{"href":"https://api.dataplatform.ibm.com/v2/connections/efa05126-da64-4104-8ba4-0e380dc2f292/assets?project_id=6d71c059-452b-4e29-989a-49d646de58a7&offset=0&limit=100&path=%2Frevenue-analysis%2Fus_revenue_%25TIME.csv"},"total_count":0,"logs":[]}}},"app_data":{"ui_data":{"label":"Cloud Object Storage","x_pos":490,"y_pos":80}}},{"id":"freeform_filter_r5lqa9viwmc","type":"execution_node","op":"ibm.streams.operations.freeform-filter","outputs":[{"id":"target","schema_ref":"schema4","links":[{"node_id_ref":"aggregate_pcl7235f81m","port_id_ref":"source"}]}],"parameters":{"expression":"c_country_code != 'US' "},"app_data":{"ui_data":{"label":"foreign revenue","x_pos":50,"y_pos":300}}},{"id":"aggregate_pcl7235f81m","type":"execution_node","op":"ibm.streams.operations.aggregate","outputs":[{"id":"target","schema_ref":"schema5","links":[{"node_id_ref":"objectstorage_v2_62t5ymbot57","port_id_ref":"source"}]}],"parameters":{"window_time_unit":"minute","window_number_of_time_units":"15","partition_by":"","group_by":"c_country_code","aggregation_output":[{"name":"country_code","value":{"function":"Any","type":"varchar","arguments":["c_country_code"]},"type":""},{"name":"revenue","value":{"function":"Sum","type":"double","arguments":["total_price_of_basket"]},"type":""}],"schema_mapping":[{"name":"country_code","type":"string"},{"name":"revenue","type":"double"}]},"app_data":{"ui_data":{"label":"Revenue by country","x_pos":250,"y_pos":300}}},{"id":"objectstorage_v2_62t5ymbot57","type":"binding","op":"ibm.streams.targets.objectstorage_v2","parameters":{"header_row_enabled":true,"write_policy":"time","rolling_time_seconds":"60"},"connection":{"ref":"efa05126-da64-4104-8ba4-0e380dc2f292","project_ref":"6d71c059-452b-4e29-989a-49d646de58a7","properties":{"asset":{"path":"/revenue-analysis/foreign_revenue_%TIME.csv","asset_types":[],"assets":[],"fields":[],"extended_metadata":[],"first":{"href":"https://api.dataplatform.ibm.com/v2/connections/efa05126-da64-4104-8ba4-0e380dc2f292/assets?project_id=6d71c059-452b-4e29-989a-49d646de58a7&offset=0&limit=100&path=%2Frevenue-analysis%2Fforeign_revenue_%25TIME.csv"},"total_count":0,"logs":[]}}},"app_data":{"ui_data":{"label":"Cloud Object Storage","x_pos":490,"y_pos":300}}}]}],"schemas":[{"id":"schema0","fields":[{"name":"customer_id","type":"string"},{"name":"click_event_type","type":"string"},{"name":"total_price_of_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"session_duration","type":"double"},{"name":"event_time","type":"string"}]},{"id":"schema1","fields":[{"name":"status","type":"string"},{"name":"c_country_code","type":"string"},{"name":"c_state","type":"string"},{"name":"c_postal_code","type":"string"},{"name":"customer_id","type":"string"},{"name":"click_event_type","type":"string"},{"name":"total_price_of_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"session_duration","type":"double"},{"name":"event_time","type":"string"}]},{"id":"schema2","fields":[{"name":"status","type":"string"},{"name":"c_country_code","type":"string"},{"name":"c_state","type":"string"},{"name":"c_postal_code","type":"string"},{"name":"customer_id","type":"string"},{"name":"click_event_type","type":"string"},{"name":"total_price_of_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"session_duration","type":"double"},{"name":"event_time","type":"string"}]},{"id":"schema3","fields":[{"name":"us_zip","type":"string"},{"name":"us_state","type":"string"},{"name":"revenue","type":"double"}]},{"id":"schema4","fields":[{"name":"status","type":"string"},{"name":"c_country_code","type":"string"},{"name":"c_state","type":"string"},{"name":"c_postal_code","type":"string"},{"name":"customer_id","type":"string"},{"name":"click_event_type","type":"string"},{"name":"total_price_of_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"session_duration","type":"double"},{"name":"event_time","type":"string"}]},{"id":"schema5","fields":[{"name":"country_code","type":"string"},{"name":"revenue","type":"double"}]}]},"engines":{"streams":{"instance_id":"b1696ac7-69b4-4d93-b924-d7e348f10ea2"}}}}